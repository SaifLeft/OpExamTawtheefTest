
@model CreateQuestionSetDto
@{
    ViewData["title"] = "إنشاء مجموعة أسئلة جديدة";
}

<div class="container-xxl flex-grow-1 container-p-y">
    <h4 class="fw-bold py-3 mb-4">
        <span class="text-muted fw-light">إدارة الأسئلة /</span> إنشاء مجموعة أسئلة جديدة
    </h4>

    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">إنشاء مجموعة أسئلة جديدة</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Name" class="form-label">اسم المجموعة</label>
                                    <input asp-for="Name" class="form-control"
                                        placeholder="أدخل اسماً مميزاً لمجموعة الأسئلة" />
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="ExamId" class="form-label">الاختبار</label>
                                    <select asp-for="ExamId" class="form-select" asp-items="ViewBag.Exams">
                                        <option value="">-- اختر الاختبار --</option>
                                    </select>
                                    <span asp-validation-for="ExamId" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">وصف المجموعة</label>
                            <textarea asp-for="Description" class="form-control" rows="3"
                                placeholder="أدخل وصفاً لمجموعة الأسئلة"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="QuestionType" class="form-label">نوع الأسئلة</label>
                                    <select asp-for="QuestionType" class="form-select" id="questionType">
                                        <option value="MCQ">اختيار من متعدد</option>
                                        <option value="TF">صح / خطأ</option>
                                        <option value="open">إجابة مفتوحة</option>
                                        <option value="fillInTheBlank">ملء الفراغات</option>
                                        <option value="ordering">ترتيب</option>
                                        <option value="matching">مطابقة</option>
                                        <option value="multiSelect">اختيار متعدد</option>
                                        <option value="shortAnswer">إجابة قصيرة</option>
                                    </select>
                                    <span asp-validation-for="QuestionType" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Language" class="form-label">اللغة</label>
                                    <select asp-for="Language" class="form-select">
                                        <option value="Arabic">العربية</option>
                                        <option value="English">الإنجليزية</option>
                                    </select>
                                    <span asp-validation-for="Language" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="QuestionCount" class="form-label">عدد الأسئلة</label>
                                    <input asp-for="QuestionCount" type="number" min="1" max="50"
                                        class="form-control" />
                                    <span asp-validation-for="QuestionCount" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="OptionsCount" class="form-label">عدد الخيارات</label>
                                    <input asp-for="OptionsCount" type="number" min="2" max="10" class="form-control" />
                                    <span asp-validation-for="OptionsCount" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="Difficulty" class="form-label">مستوى الصعوبة</label>
                                    <select asp-for="Difficulty" class="form-select">
                                        <option value="easy">سهل</option>
                                        <option value="medium">متوسط</option>
                                        <option value="hard">صعب</option>
                                        <option value="auto">تلقائي</option>
                                    </select>
                                    <span asp-validation-for="Difficulty" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row" id="specialOptions">
                            <div class="col-md-6" id="numberOfRowsContainer" style="display:none;">
                                <div class="mb-3">
                                    <label asp-for="NumberOfRows" class="form-label">عدد العناصر في
                                        التطابق/الترتيب</label>
                                    <input asp-for="NumberOfRows" type="number" min="2" max="10" class="form-control" />
                                    <span asp-validation-for="NumberOfRows" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6" id="numberOfCorrectOptionsContainer" style="display:none;">
                                <div class="mb-3">
                                    <label asp-for="NumberOfCorrectOptions" class="form-label">عدد الإجابات
                                        الصحيحة</label>
                                    <input asp-for="NumberOfCorrectOptions" type="number" min="1" max="5"
                                        class="form-control" />
                                    <span asp-validation-for="NumberOfCorrectOptions" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">مصدر المحتوى</label>
                            <select id="contentTypeSelector" class="form-select" name="ContentType">
                                <option value="topic">موضوع</option>
                                <option value="text">نص</option>
                                <option value="link">رابط</option>
                                <option value="youtube">رابط يوتيوب</option>
                                <option value="document">مستند</option>
                                <option value="image">صورة</option>
                                <option value="audio">ملف صوتي</option>
                                <option value="video">فيديو</option>
                            </select>
                        </div>

                        <div id="contentSourceForms">
                            <div id="topic-form" class="content-form">
                                <div class="mb-3">
                                    <label asp-for="Topic" class="form-label">الموضوع</label>
                                    <input asp-for="Topic" class="form-control"
                                        placeholder="أدخل الموضوع الذي تريد توليد أسئلة عنه" />
                                    <span asp-validation-for="Topic" class="text-danger"></span>
                                </div>
                            </div>

                            <div id="text-form" class="content-form" style="display:none;">
                                <div class="mb-3">
                                    <label asp-for="TextContent" class="form-label">النص</label>
                                    <textarea asp-for="TextContent" class="form-control" rows="5"
                                        placeholder="أدخل النص الذي تريد توليد أسئلة منه"></textarea>
                                    <span asp-validation-for="TextContent" class="text-danger"></span>
                                </div>
                            </div>

                            <div id="link-form" class="content-form" style="display:none;">
                                <div class="mb-3">
                                    <label asp-for="LinkUrl" class="form-label">الرابط</label>
                                    <input asp-for="LinkUrl" type="url" class="form-control"
                                        placeholder="أدخل رابط الموقع الذي تريد توليد أسئلة منه" />
                                    <span asp-validation-for="LinkUrl" class="text-danger"></span>
                                </div>
                            </div>

                            <div id="youtube-form" class="content-form" style="display:none;">
                                <div class="mb-3">
                                    <label asp-for="YoutubeUrl" class="form-label">رابط فيديو يوتيوب</label>
                                    <input asp-for="YoutubeUrl" type="url" class="form-control"
                                        placeholder="أدخل رابط فيديو يوتيوب الذي تريد توليد أسئلة منه" />
                                    <span asp-validation-for="YoutubeUrl" class="text-danger"></span>
                                </div>
                            </div>

                            <div id="file-form" class="content-form" style="display:none;">
                                <div class="mb-3">
                                    <label for="file" class="form-label">الملف</label>
                                    <input id="fileUpload" type="file" class="form-control" />
                                    <input type="hidden" id="fileReference" name="FileReference" />
                                    <div class="progress mt-2" style="display:none;" id="uploadProgress">
                                        <div class="progress-bar" role="progressbar" style="width: 0%;"
                                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                    </div>
                                    <small class="form-text text-muted" id="uploadStatus"></small>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary me-2">إنشاء مجموعة الأسئلة</button>
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">إلغاء</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Toggle content source forms
            $('#contentTypeSelector').change(function () {
                var selectedType = $(this).val();
                $('.content-form').hide();

                if (selectedType === 'topic') {
                    $('#topic-form').show();
                } else if (selectedType === 'text') {
                    $('#text-form').show();
                } else if (selectedType === 'link') {
                    $('#link-form').show();
                } else if (selectedType === 'youtube') {
                    $('#youtube-form').show();
                } else if (['document', 'image', 'audio', 'video'].includes(selectedType)) {
                    $('#file-form').show();
                }
            });

            // Toggle special options based on question type
            $('#questionType').change(function () {
                var questionType = $(this).val();

                // Hide all special containers
                $('#numberOfRowsContainer, #numberOfCorrectOptionsContainer').hide();

                // Show specific containers based on question type
                if (questionType === 'matching' || questionType === 'ordering') {
                    $('#numberOfRowsContainer').show();
                }

                if (questionType === 'multiSelect') {
                    $('#numberOfCorrectOptionsContainer').show();
                }
            });

            // File upload handling
            $('#fileUpload').change(function () {
                if (this.files.length > 0) {
                    uploadFile(this.files[0]);
                }
            });

            function uploadFile(file) {
                var formData = new FormData();
                formData.append('file', file);

                $('#uploadProgress').show();

                $.ajax({
                    url: '@Url.Action("UploadFile", "FileUpload")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    xhr: function () {
                        var xhr = new window.XMLHttpRequest();
                        xhr.upload.addEventListener('progress', function (evt) {
                            if (evt.lengthComputable) {
                                var percentComplete = evt.loaded / evt.total * 100;
                                $('.progress-bar').css('width', percentComplete + '%').attr('aria-valuenow', percentComplete).text(Math.round(percentComplete) + '%');
                            }
                        }, false);
                        return xhr;
                    },
                    success: function (response) {
                        $('#fileReference').val(response.fileReference);
                        $('#uploadStatus').text('تم رفع الملف بنجاح.');
                        $('.progress-bar').addClass('bg-success');
                    },
                    error: function (xhr, status, error) {
                        $('#uploadStatus').text('حدث خطأ أثناء رفع الملف: ' + error);
                        $('.progress-bar').addClass('bg-danger');
                    }
                });
            }
        });
    </script>
}
